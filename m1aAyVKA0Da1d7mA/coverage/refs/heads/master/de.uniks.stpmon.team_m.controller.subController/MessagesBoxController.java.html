<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessagesBoxController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stp-23-team-m</a> &gt; <a href="index.source.html" class="el_package">de.uniks.stpmon.team_m.controller.subController</a> &gt; <span class="el_source">MessagesBoxController.java</span></div><h1>MessagesBoxController.java</h1><pre class="source lang-java linenums">package de.uniks.stpmon.team_m.controller.subController;

import de.uniks.stpmon.team_m.controller.Controller;
import de.uniks.stpmon.team_m.dto.Group;
import de.uniks.stpmon.team_m.dto.Message;
import de.uniks.stpmon.team_m.dto.User;
import de.uniks.stpmon.team_m.service.GroupService;
import de.uniks.stpmon.team_m.service.GroupStorage;
import de.uniks.stpmon.team_m.service.MessageService;
import de.uniks.stpmon.team_m.service.UserStorage;
import de.uniks.stpmon.team_m.ws.EventListener;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.scene.Parent;
import javafx.scene.control.Alert;
import javafx.scene.control.Label;
import javafx.scene.control.ListView;
import javafx.scene.control.TextInputDialog;

import javax.inject.Provider;
import java.util.List;

import static de.uniks.stpmon.team_m.Constants.MESSAGE_NAMESPACE_GROUPS;
import static de.uniks.stpmon.team_m.Constants.UNKNOWN_USER;

public class MessagesBoxController extends Controller {

    private final User user;
    private final MessageService messageService;
    private final GroupService groupService;
    private final GroupStorage groupStorage;
    private final UserStorage userStorage;
    private final Group group;
    private final List&lt;User&gt; allUsers;
    private String chatID;
<span class="fc" id="L36">    private final ObservableList&lt;Message&gt; messages = FXCollections.observableArrayList();</span>
    Provider&lt;EventListener&gt; eventListener;
    private ListView&lt;Message&gt; messageListView;

<span class="fc" id="L40">    public MessagesBoxController(MessageService messageService, GroupService groupService, Provider&lt;EventListener&gt; eventListener, GroupStorage groupStorage, UserStorage userStorage, List&lt;User&gt; allUsers, User user, Group group) {</span>
<span class="fc" id="L41">        this.messageService = messageService;</span>
<span class="fc" id="L42">        this.groupService = groupService;</span>
<span class="fc" id="L43">        this.eventListener = eventListener;</span>
<span class="fc" id="L44">        this.groupStorage = groupStorage;</span>
<span class="fc" id="L45">        this.userStorage = userStorage;</span>
<span class="fc" id="L46">        this.allUsers = allUsers;</span>
<span class="fc" id="L47">        this.user = user;</span>
<span class="fc" id="L48">        this.group = group;</span>
<span class="fc" id="L49">    }</span>

    @Override
    public String getTitle() {
<span class="nc" id="L53">        return null;</span>
    }

    @Override
    public void init() {
<span class="fc" id="L58">        messageListView = new ListView&lt;&gt;(messages);</span>
<span class="pc" id="L59">        messageListView.setCellFactory(param -&gt; new MessageCell(this, userStorage.get_id()));</span>
<span class="fc" id="L60">        messageListView.setPlaceholder(new Label(&quot;\t\tNo messages yet\n&quot; +</span>
                &quot;or there is no user or group selected&quot;));
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">        if (group == null) {</span>
<span class="fc" id="L63">            openFriendChat(&quot;userListView&quot;);</span>
        }
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L66">            openFriendChat(&quot;groupListView&quot;);</span>
        }
<span class="fc" id="L68">        messageListView.setFocusTraversable(false);</span>
<span class="fc" id="L69">    }</span>

    @Override
    public Parent render() {
<span class="fc" id="L73">        groupStorage.set_id(chatID);</span>
<span class="fc" id="L74">        messageListView.scrollTo(messageListView.getItems().size() - 1);</span>
<span class="fc" id="L75">        return messageListView;</span>
    }

    private void openFriendChat(String origin) {

        final Group chat;
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        if (origin.equals(&quot;userListView&quot;)) {</span>
<span class="fc" id="L82">            chat = new Group(null, null, List.of(user._id(), userStorage.get_id()));</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        } else if (origin.equals(&quot;groupListView&quot;)) {</span>
<span class="nc" id="L84">            chat = group;</span>
        } else {
<span class="nc" id="L86">            chat = new Group(null, null, List.of(user._id(), userStorage.get_id()));</span>
        }

<span class="fc" id="L89">        disposables.add(groupService.getGroups(chat.membersToString())</span>
<span class="fc" id="L90">                .observeOn(FX_SCHEDULER).subscribe(gotGroups -&gt; {</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">                    if (chat.name() == null) {</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">                        for (Group group : gotGroups) {</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">                            if (group.name() == null) {</span>
<span class="nc" id="L94">                                chatID = group._id();</span>
<span class="nc" id="L95">                                break;</span>
                            }
<span class="fc" id="L97">                            chatID = null;</span>
<span class="fc" id="L98">                        }</span>
                    } else {
<span class="nc" id="L100">                        chatID = chat._id();</span>
                    }

<span class="pc bpc" id="L103" title="1 of 2 branches missed.">                    if (chatID != null) {</span>
<span class="nc" id="L104">                        groupStorage.set_id(chatID);</span>

<span class="nc" id="L106">                        disposables.add(messageService.getGroupMessages(chatID)</span>
<span class="nc" id="L107">                                .observeOn(FX_SCHEDULER).subscribe(messages -&gt; {</span>
<span class="nc" id="L108">                                    this.messages.setAll(messages);</span>
<span class="nc" id="L109">                                    listenToMessages(messageListView, this.messages, chatID);</span>
<span class="nc" id="L110">                                    messageListView.scrollTo(messageListView.getItems().size() - 1);</span>
<span class="nc" id="L111">                                }, error -&gt; showError(error.getMessage())));</span>
                    }
<span class="pc" id="L113">                }, error -&gt; showError(error.getMessage())));</span>
<span class="fc" id="L114">    }</span>

    public String getUsername(String _id) {
<span class="nc bnc" id="L117" title="All 2 branches missed.">        for (User user : allUsers) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (user._id().equals(_id)) {</span>
<span class="nc" id="L119">                return user.name();</span>
            }
<span class="nc" id="L121">        }</span>
<span class="nc" id="L122">        return UNKNOWN_USER;</span>
    }

    public void editMessage(TextInputDialog dialog, String newBody, Message message) {
<span class="nc" id="L126">        disposables.add(messageService.updateMessage(groupStorage.get_id(), message._id(), newBody, MESSAGE_NAMESPACE_GROUPS)</span>
<span class="nc" id="L127">                .observeOn(FX_SCHEDULER).subscribe(event -&gt; {</span>
<span class="nc" id="L128">                }, error -&gt; showError(error.getMessage())));</span>
<span class="nc" id="L129">        dialog.close();</span>
<span class="nc" id="L130">    }</span>

    public void deleteMessage(Alert alert, Message item) {
<span class="nc" id="L133">        disposables.add(messageService.deleteMessage(item._id(), groupStorage.get_id(), MESSAGE_NAMESPACE_GROUPS)</span>
<span class="nc" id="L134">                .observeOn(FX_SCHEDULER).subscribe(event -&gt; {</span>
<span class="nc" id="L135">                }, error -&gt; showError(error.getMessage())));</span>
<span class="nc" id="L136">        alert.close();</span>
<span class="nc" id="L137">    }</span>

    public void listenToMessages(ListView&lt;Message&gt; messageListView, ObservableList&lt;Message&gt; messages, String id) {
<span class="nc" id="L140">        disposables.add(eventListener.get().listen(&quot;groups.&quot; + id + &quot;.messages.*.*&quot;, Message.class)</span>
<span class="nc" id="L141">                .observeOn(FX_SCHEDULER).subscribe(event -&gt; {</span>
<span class="nc" id="L142">                    final Message message = event.data();</span>
<span class="nc bnc" id="L143" title="All 4 branches missed.">                    switch (event.suffix()) {</span>
                        case &quot;created&quot; -&gt; {
<span class="nc" id="L145">                            messages.add(message);</span>
<span class="nc" id="L146">                            messageListView.scrollTo(message);</span>
<span class="nc" id="L147">                        }</span>
                        case &quot;updated&quot; -&gt; {
<span class="nc" id="L149">                            String messageID = message._id();</span>
<span class="nc" id="L150">                            messageListView.getItems().stream()</span>
<span class="nc" id="L151">                                    .filter(m -&gt; m._id().equals(messageID))</span>
<span class="nc" id="L152">                                    .findFirst()</span>
<span class="nc" id="L153">                                    .ifPresent(m -&gt; messageListView.getItems().set(messageListView.getItems().indexOf(m), message));</span>
<span class="nc" id="L154">                        }</span>
<span class="nc" id="L155">                        case &quot;deleted&quot; -&gt; messages.removeIf(m -&gt; m._id().equals(message._id()));</span>
                    }
<span class="nc" id="L157">                }));</span>
<span class="nc" id="L158">    }</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>