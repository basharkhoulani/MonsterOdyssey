<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessagesUserCell.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stp-23-team-m</a> &gt; <a href="index.source.html" class="el_package">de.uniks.stpmon.team_m.controller.subController</a> &gt; <span class="el_source">MessagesUserCell.java</span></div><h1>MessagesUserCell.java</h1><pre class="source lang-java linenums">package de.uniks.stpmon.team_m.controller.subController;

import de.uniks.stpmon.team_m.dto.Group;
import de.uniks.stpmon.team_m.dto.Message;
import de.uniks.stpmon.team_m.dto.User;
import de.uniks.stpmon.team_m.service.GroupService;
import de.uniks.stpmon.team_m.service.MessageService;
import de.uniks.stpmon.team_m.service.UserStorage;
import de.uniks.stpmon.team_m.service.UsersService;
import io.reactivex.rxjava3.disposables.CompositeDisposable;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.ScrollPane;
import javafx.scene.layout.*;
import javafx.scene.paint.Color;
import javafx.scene.paint.Paint;
import javafx.scene.text.Text;

import javax.inject.Provider;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Objects;
import java.util.prefs.Preferences;

import static de.uniks.stpmon.team_m.controller.Controller.FX_SCHEDULER;

public class MessagesUserCell extends UserCell{
    private final VBox chatVBox;
    protected final CompositeDisposable disposables;
<span class="fc" id="L35">    private final ObservableList&lt;Group&gt; groups = FXCollections.observableArrayList();</span>
<span class="fc" id="L36">    private final ObservableList&lt;Message&gt; messages = FXCollections.observableArrayList();</span>
    private final Text currentFriendOrGroupText;
    private final ScrollPane chatScrollPane;
    private Group privateChat;

    private final Provider&lt;UserStorage&gt; userStorageProvider;
    private final UsersService usersService;
    private final MessageService messageService;
    private final GroupService groupService;

    // Inject won't work, so I had to do it the old-fashioned way. Figured it would take too long to look for the problem
    public MessagesUserCell(Preferences preferences,
                            VBox chatVbox,
                            Text currentFriendOrGroupText,
                            ScrollPane chatScrollPane,
                            Provider&lt;UserStorage&gt; userStorageProvider,
                            UsersService usersService,
                            MessageService messageService,
                            GroupService groupService,
                            CompositeDisposable disposable) {
<span class="fc" id="L56">        super(preferences);</span>
<span class="fc" id="L57">        this.chatVBox = chatVbox;</span>
<span class="fc" id="L58">        this.currentFriendOrGroupText = currentFriendOrGroupText;</span>
<span class="fc" id="L59">        this.userStorageProvider = userStorageProvider;</span>
<span class="fc" id="L60">        this.usersService = usersService;</span>
<span class="fc" id="L61">        this.messageService = messageService;</span>
<span class="fc" id="L62">        this.groupService = groupService;</span>
<span class="fc" id="L63">        this.chatScrollPane = chatScrollPane;</span>
<span class="fc" id="L64">        this.disposables = disposable;</span>
<span class="fc" id="L65">    }</span>
    @Override
    protected void updateItem(User item, boolean empty) {
<span class="fc" id="L68">        super.updateItem(item, empty);</span>
<span class="fc" id="L69">        HBox friendNode = this.getRootHBox();</span>

<span class="fc bfc" id="L71" title="All 2 branches covered.">        if (item == null) {</span>
<span class="fc" id="L72">            setText(null);</span>
<span class="fc" id="L73">            setGraphic(null);</span>
        } else {
<span class="fc" id="L75">            disposables.add(groupService.getGroups(List.of(item._id(), userStorageProvider.get().get_id()))</span>
<span class="fc" id="L76">                    .observeOn(FX_SCHEDULER).subscribe(groups::setAll));</span>

<span class="fc bfc" id="L78" title="All 2 branches covered.">            for (Group group : groups) {</span>
<span class="pc bpc" id="L79" title="3 of 4 branches missed.">                if (Objects.equals(group.name(), &quot;&quot;) || group.name() == null) {</span>
<span class="fc" id="L80">                    this.privateChat = group;</span>
<span class="fc" id="L81">                    break;</span>
                }
<span class="nc" id="L83">                this.privateChat = null;</span>
<span class="nc" id="L84">            }</span>

<span class="fc" id="L86">            friendNode.setOnMouseClicked(event -&gt; {</span>
<span class="fc" id="L87">                this.currentFriendOrGroupText.setText(item.name());</span>
<span class="fc" id="L88">                chatVBox.getChildren().clear();</span>

<span class="fc bfc" id="L90" title="All 2 branches covered.">                if (this.privateChat != null) {</span>
<span class="fc" id="L91">                    disposables.add(messageService.getGroupMessages(privateChat._id())</span>
<span class="fc" id="L92">                            .observeOn(FX_SCHEDULER).subscribe(messages::setAll));</span>

<span class="fc bfc" id="L94" title="All 2 branches covered.">                    for (Message message : messages) {</span>
<span class="fc" id="L95">                        chatVBox.getChildren().add(this.createMessageNode(message));</span>
<span class="fc" id="L96">                    }</span>

<span class="fc" id="L98">                    chatScrollPane.setVvalue(1.0);</span>
                }
<span class="fc" id="L100">            });</span>
        }
<span class="fc" id="L102">    }</span>

    public VBox createMessageNode(Message message) {
<span class="fc" id="L105">        VBox newMessageNode = new VBox();</span>
<span class="fc" id="L106">        HBox newMessageValueArea = new HBox();</span>
<span class="fc" id="L107">        HBox newMessageInfoArea = new HBox();</span>

        // @Cheng, so you can call delete and edit functionality on this message
<span class="fc" id="L110">        newMessageNode.setId(message._id());</span>

<span class="fc" id="L112">        newMessageValueArea.maxWidthProperty().bind(chatVBox.widthProperty().map(number -&gt; number.intValue() / 2 - 20));</span>
<span class="fc" id="L113">        newMessageInfoArea.maxWidthProperty().bind(chatVBox.widthProperty().map(number -&gt; number.intValue() / 2 - 20));</span>

<span class="fc" id="L115">        boolean userIsSender = message.sender().equals(userStorageProvider.get().get_id());</span>
        // if user is sender: message is on the right, else on the left
<span class="fc bfc" id="L117" title="All 2 branches covered.">        newMessageNode.setAlignment(userIsSender ? Pos.TOP_RIGHT : Pos.TOP_LEFT);</span>

<span class="fc" id="L119">        newMessageValueArea.setBorder(new Border(</span>
                new BorderStroke(
                        Color.BLACK,
                        BorderStrokeStyle.SOLID,
                        new CornerRadii(10),
                        new BorderWidths(2)
                )
        ));

<span class="fc" id="L128">        Text messageText = new Text();</span>
<span class="fc" id="L129">        messageText.setText(message.body());</span>
<span class="fc" id="L130">        messageText.wrappingWidthProperty().bind(chatVBox.widthProperty().map(number -&gt; number.intValue() / 2 - 20));</span>

<span class="fc" id="L132">        VBox newMessageValueContainer = new VBox();</span>
<span class="fc" id="L133">        newMessageValueContainer.getChildren().add(messageText);</span>
<span class="fc" id="L134">        newMessageValueArea.getChildren().add(newMessageValueContainer);</span>

<span class="fc" id="L136">        newMessageValueArea.setPadding(new Insets(2));</span>
<span class="fc" id="L137">        newMessageValueContainer.setPadding(new Insets(5));</span>

<span class="fc" id="L139">        Label authorAndTime = new Label();</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">        if (userIsSender) {</span>
<span class="fc" id="L141">            authorAndTime.setText(userStorageProvider.get().getName() +</span>
                    &quot; &quot; +
<span class="fc" id="L143">                    formatTimeString(message.createdAt()) +</span>
                    &quot; &quot; +
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">                    (message.updatedAt() == null ? &quot;&quot; : &quot;\u270F&quot;));</span>


<span class="fc" id="L148">            newMessageValueContainer.setBackground(Background.fill(Paint.valueOf(&quot;lightblue&quot;)));</span>
        } else {
<span class="fc" id="L150">            final String[] senderName = {&quot;&quot;};</span>
<span class="fc" id="L151">            usersService.getUser(message.sender()).map(</span>
                    user -&gt; {
<span class="fc" id="L153">                        senderName[0] = user.name();</span>
<span class="fc" id="L154">                        return user;</span>
                    }
<span class="fc" id="L156">            ).subscribe().dispose();</span>

<span class="fc" id="L158">            authorAndTime.setText(senderName[0] +</span>
                    &quot; &quot; +
<span class="fc" id="L160">                    formatTimeString(message.createdAt()) +</span>
                    &quot; &quot; +
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">                    (message.updatedAt() == null ? &quot;&quot; : &quot;\u270F&quot;));</span>
        }

<span class="fc" id="L165">        newMessageInfoArea.getChildren().add(authorAndTime);</span>

<span class="fc" id="L167">        Button editButton = new Button(&quot;\u270F&quot;);</span>
<span class="fc" id="L168">        editButton.setOnAction(event -&gt; {</span>
            // @Cheng
<span class="nc" id="L170">        });</span>

<span class="fc" id="L172">        Button deleteButton = new Button(&quot;\uD83D\uDDD1&quot;);</span>
<span class="fc" id="L173">        deleteButton.setOnAction(event -&gt; {</span>
            // @Cheng
<span class="nc" id="L175">        });</span>
<span class="fc" id="L176">        newMessageInfoArea.getChildren().addAll(editButton, deleteButton);</span>

<span class="fc" id="L178">        newMessageInfoArea.setFillHeight(true);</span>
<span class="fc" id="L179">        HBox.setMargin(editButton, new Insets(0, 0, 0, 5));</span>
<span class="fc" id="L180">        HBox.setMargin(deleteButton, new Insets(0, 0, 0, 5));</span>
<span class="fc" id="L181">        editButton.setVisible(false);</span>
<span class="fc" id="L182">        deleteButton.setVisible(false);</span>

<span class="fc" id="L184">        newMessageNode.getChildren().add(newMessageValueArea);</span>
<span class="fc" id="L185">        newMessageNode.getChildren().add(newMessageInfoArea);</span>

<span class="fc" id="L187">        newMessageNode.hoverProperty().addListener((observable, oldValue, newValue) -&gt; {</span>
<span class="fc" id="L188">            editButton.setVisible(newValue);</span>
<span class="fc" id="L189">            deleteButton.setVisible(newValue);</span>
<span class="fc" id="L190">        });</span>

<span class="fc" id="L192">        return newMessageNode;</span>
    }

    private String formatTimeString(String dateTime) {
<span class="fc" id="L196">        DateTimeFormatter inputFormatter = DateTimeFormatter.ISO_OFFSET_DATE_TIME;</span>
<span class="fc" id="L197">        LocalDateTime localDateTime = LocalDateTime.parse(dateTime, inputFormatter);</span>

<span class="fc" id="L199">        DateTimeFormatter outputFormatter = DateTimeFormatter.ofPattern(&quot;HH:mm, dd.MM.yy&quot;);</span>
<span class="fc" id="L200">        return localDateTime.format(outputFormatter);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>