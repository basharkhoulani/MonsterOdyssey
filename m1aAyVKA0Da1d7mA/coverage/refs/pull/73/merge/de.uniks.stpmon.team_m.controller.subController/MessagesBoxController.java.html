<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessagesBoxController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stp-23-team-m</a> &gt; <a href="index.source.html" class="el_package">de.uniks.stpmon.team_m.controller.subController</a> &gt; <span class="el_source">MessagesBoxController.java</span></div><h1>MessagesBoxController.java</h1><pre class="source lang-java linenums">package de.uniks.stpmon.team_m.controller.subController;

import de.uniks.stpmon.team_m.Constants;
import de.uniks.stpmon.team_m.controller.Controller;
import de.uniks.stpmon.team_m.dto.Group;
import de.uniks.stpmon.team_m.dto.Message;
import de.uniks.stpmon.team_m.dto.User;
import de.uniks.stpmon.team_m.service.*;
import de.uniks.stpmon.team_m.ws.EventListener;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Node;
import javafx.scene.Parent;
import javafx.scene.control.*;
import javafx.scene.layout.*;
import javafx.scene.paint.Color;
import javafx.scene.paint.Paint;
import javafx.scene.text.Text;

import javax.inject.Provider;
import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Objects;

import static de.uniks.stpmon.team_m.Constants.MESSAGE_NAMESPACE_GROUPS;

public class MessagesBoxController extends Controller {

    private final User user;
    private final VBox chatViewVBox;
    private final ScrollPane chatScrollPane;

    private final Text currentFriendOrGroupText;
    private final MessageService messageService;
    private final GroupService groupService;
    private final GroupStorage groupStorage;
    private final UserStorage userStorage;
    private final UsersService usersService;
    private final Group group;
    private String chatID;
<span class="fc" id="L46">    private final ObservableList&lt;Message&gt; messages = FXCollections.observableArrayList();</span>
    Provider&lt;EventListener&gt; eventListener;
<span class="fc" id="L48">    boolean isInitialized = false;</span>

<span class="fc" id="L50">    public MessagesBoxController(MessageService messageService, GroupService groupService, Provider&lt;EventListener&gt; eventListener, UsersService usersService, GroupStorage groupStorage, UserStorage userStorage, User user, Group group, VBox chatViewVBox, ScrollPane chatScrollPane, Text currentFriendOrGroupText) {</span>
<span class="fc" id="L51">        this.messageService = messageService;</span>
<span class="fc" id="L52">        this.groupService = groupService;</span>
<span class="fc" id="L53">        this.eventListener = eventListener;</span>
<span class="fc" id="L54">        this.usersService = usersService;</span>
<span class="fc" id="L55">        this.groupStorage = groupStorage;</span>
<span class="fc" id="L56">        this.userStorage = userStorage;</span>
<span class="fc" id="L57">        this.user = user;</span>
<span class="fc" id="L58">        this.group = group;</span>
<span class="fc" id="L59">        this.chatViewVBox = chatViewVBox;</span>
<span class="fc" id="L60">        this.chatScrollPane = chatScrollPane;</span>
<span class="fc" id="L61">        this.currentFriendOrGroupText = currentFriendOrGroupText;</span>
<span class="fc" id="L62">    }</span>

    @Override
    public String getTitle() {
<span class="nc" id="L66">        return null;</span>
    }

    @Override
    public Parent render() {
<span class="fc" id="L71">        Parent parent = new Parent() {</span>
        };
<span class="fc bfc" id="L73" title="All 2 branches covered.">        if (group == null) {</span>
<span class="fc" id="L74">            openFriendChat(&quot;userListView&quot;);</span>
        }
<span class="fc bfc" id="L76" title="All 2 branches covered.">        if (user == null) {</span>
<span class="fc" id="L77">            openFriendChat(&quot;groupListView&quot;);</span>
        }
<span class="fc" id="L79">        return parent;</span>
    }

    private void openFriendChat(String origin) {

        final Group chat;
<span class="fc bfc" id="L85" title="All 2 branches covered.">        if (origin.equals(&quot;userListView&quot;)) {</span>
<span class="fc" id="L86">            chat = new Group(null, null, List.of(user._id(), userStorage.get_id()));</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        } else if (origin.equals(&quot;groupListView&quot;)) {</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">            if (group.name() == null) {</span>
<span class="nc" id="L89">                chat = group;</span>
            } else {
<span class="fc" id="L91">                chat = group;</span>
            }
        } else {
<span class="nc" id="L94">            chat = new Group(null, null, List.of(user._id(), userStorage.get_id()));</span>
        }

<span class="fc" id="L97">        disposables.add(groupService.getGroups(chat.membersToString())</span>
<span class="fc" id="L98">                .observeOn(FX_SCHEDULER).subscribe(gotGroups -&gt; {</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">                    if (chat.name() == null) {</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">                        for (Group group : gotGroups) {</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">                            if (Objects.equals(group.name(), &quot;&quot;)) {</span>
<span class="fc" id="L102">                                chatID = group._id();</span>
<span class="fc" id="L103">                                break;</span>
                            }
<span class="nc" id="L105">                            chatID = null;</span>
<span class="pc" id="L106">                        }</span>
                    } else {
<span class="fc" id="L108">                        chatID = chat._id();</span>
                    }

<span class="fc bfc" id="L111" title="All 2 branches covered.">                    if (origin.equals(&quot;userListView&quot;)) {</span>
<span class="fc" id="L112">                        this.currentFriendOrGroupText.setText(user.name());</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                    } else if (origin.equals(&quot;groupListView&quot;)) {</span>
<span class="fc" id="L114">                        this.currentFriendOrGroupText.setText(chat.name());</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">                        if(chat.name()==null){</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                            for (String id: chat.members()){</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                                if(!id.equals(userStorage.get_id())){</span>
<span class="nc" id="L118">                                    disposables.add(usersService.getUser(id)</span>
<span class="nc" id="L119">                                            .observeOn(FX_SCHEDULER).subscribe(user -&gt; {</span>
<span class="nc" id="L120">                                                this.currentFriendOrGroupText.setText(user.name());</span>
<span class="nc" id="L121">                                            }, error -&gt; {</span>
<span class="nc" id="L122">                                                this.currentFriendOrGroupText.setText(&quot;Unknown User&quot;);</span>
<span class="nc" id="L123">                                            }));</span>
                                }
<span class="nc" id="L125">                            }</span>
                        }
                    } else {
<span class="nc" id="L128">                        this.currentFriendOrGroupText.setText(user.name());</span>
                    }

<span class="fc" id="L131">                    chatViewVBox.getChildren().clear();</span>

<span class="pc bpc" id="L133" title="1 of 2 branches missed.">                    if (chatID != null) {</span>
<span class="fc" id="L134">                        groupStorage.set_id(chatID);</span>

<span class="fc" id="L136">                        disposables.add(messageService.getGroupMessages(chatID)</span>
<span class="fc" id="L137">                                .observeOn(FX_SCHEDULER).subscribe(messages -&gt; {</span>
<span class="fc" id="L138">                                    chatViewVBox.getChildren().clear();</span>
<span class="fc" id="L139">                                    this.messages.setAll(messages);</span>

<span class="fc bfc" id="L141" title="All 2 branches covered.">                                    for (Message message : messages) {</span>
<span class="fc" id="L142">                                        chatViewVBox.getChildren().add(this.createMessageNode(message));</span>
<span class="fc" id="L143">                                    }</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">                                    if (!isInitialized) {</span>
<span class="fc" id="L145">                                        disposables.add(eventListener.get()</span>
<span class="fc" id="L146">                                                .listen(&quot;groups.&quot; + chatID + &quot;.messages.*.*&quot;, Message.class)</span>
<span class="fc" id="L147">                                                .observeOn(FX_SCHEDULER)</span>
<span class="fc" id="L148">                                                .subscribe(messageEvent -&gt; {</span>
<span class="nc" id="L149">                                                    final Message message = messageEvent.data();</span>
<span class="nc bnc" id="L150" title="All 4 branches missed.">                                                    switch (messageEvent.suffix()) {</span>
                                                        case &quot;created&quot; -&gt; {
<span class="nc" id="L152">                                                            chatViewVBox.getChildren().add(createMessageNode(message));</span>
<span class="nc" id="L153">                                                            chatScrollPane.setVvalue(1.0);</span>
<span class="nc" id="L154">                                                        }</span>
                                                        case &quot;updated&quot; -&gt; {
<span class="nc bnc" id="L156" title="All 2 branches missed.">                                                            for (Node messageNode : chatViewVBox.getChildren()) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                                                                if (Objects.equals(messageNode.getId(), message._id())) {</span>
<span class="nc" id="L158">                                                                    VBox messageVBox = (VBox) messageNode;</span>
<span class="nc" id="L159">                                                                    HBox messageValueAreaContainer = (HBox) messageVBox.getChildren().get(0);</span>
<span class="nc" id="L160">                                                                    VBox messageValueArea = (VBox) messageValueAreaContainer.getChildren().get(0);</span>
<span class="nc" id="L161">                                                                    Text messageValueText = (Text) messageValueArea.getChildren().get(0);</span>

<span class="nc" id="L163">                                                                    messageValueText.setText(message.body());</span>

<span class="nc" id="L165">                                                                    HBox messageInfoArea = (HBox) messageVBox.getChildren().get(1);</span>
<span class="nc" id="L166">                                                                    Label edited = (Label) messageInfoArea.getChildren().get(1);</span>
<span class="nc" id="L167">                                                                    edited.setVisible(true);</span>
                                                                }
<span class="nc" id="L169">                                                            }</span>
<span class="nc" id="L170">                                                        }</span>
<span class="nc" id="L171">                                                        case &quot;deleted&quot; -&gt; chatViewVBox.getChildren().removeIf(</span>
<span class="nc" id="L172">                                                                node -&gt; Objects.equals(node.getId(), message._id())</span>
                                                        );
                                                    }
<span class="nc" id="L175">                                                }));</span>
<span class="fc" id="L176">                                        isInitialized = true;</span>
                                    }
<span class="fc" id="L178">                                }));</span>
                    }
<span class="fc" id="L180">                }));</span>
<span class="fc" id="L181">    }</span>

    public VBox createMessageNode(Message message) {
<span class="fc" id="L184">        VBox newMessageNode = new VBox();</span>
<span class="fc" id="L185">        HBox newMessageValueArea = new HBox();</span>
<span class="fc" id="L186">        HBox newMessageInfoArea = new HBox();</span>

        // @Cheng, so you can call delete and edit functionality on this message
<span class="fc" id="L189">        newMessageNode.setId(message._id());</span>

<span class="fc" id="L191">        newMessageValueArea.maxWidthProperty().bind(chatViewVBox.widthProperty().map(number -&gt; number.intValue() / 2 - 20));</span>
<span class="fc" id="L192">        newMessageInfoArea.maxWidthProperty().bind(chatViewVBox.widthProperty().map(number -&gt; number.intValue() / 2 - 20));</span>

<span class="fc" id="L194">        boolean userIsSender = message.sender().equals(userStorage.get_id());</span>
        // if user is sender: message is on the right, else on the left
<span class="fc bfc" id="L196" title="All 2 branches covered.">        newMessageNode.setAlignment(userIsSender ? Pos.TOP_RIGHT : Pos.TOP_LEFT);</span>

<span class="fc" id="L198">        newMessageValueArea.setBorder(new Border(</span>
                new BorderStroke(
                        Color.BLACK,
                        BorderStrokeStyle.SOLID,
                        new CornerRadii(10),
                        new BorderWidths(2)
                )
        ));

<span class="fc" id="L207">        Text messageText = new Text();</span>
<span class="fc" id="L208">        messageText.setText(message.body());</span>
<span class="fc" id="L209">        messageText.wrappingWidthProperty().bind(chatViewVBox.widthProperty().map(number -&gt; number.intValue() / 2 - 20));</span>

<span class="fc" id="L211">        VBox newMessageValueContainer = new VBox();</span>
<span class="fc" id="L212">        newMessageValueContainer.getChildren().add(messageText);</span>
<span class="fc" id="L213">        newMessageValueArea.getChildren().add(newMessageValueContainer);</span>

<span class="fc" id="L215">        newMessageValueArea.setPadding(new Insets(2));</span>
<span class="fc" id="L216">        newMessageValueContainer.setPadding(new Insets(5));</span>

<span class="fc" id="L218">        Label authorAndTime = new Label();</span>
<span class="fc" id="L219">        Label edited = new Label();</span>
<span class="fc" id="L220">        edited.setText(&quot;\u270F&quot;);</span>

<span class="fc bfc" id="L222" title="All 2 branches covered.">        if (userIsSender) {</span>
<span class="fc" id="L223">            authorAndTime.setText(userStorage.getName() +</span>
                    &quot; &quot; +
<span class="fc" id="L225">                    formatTimeString(message.createdAt()) +</span>
                    &quot; &quot;);

<span class="fc" id="L228">            newMessageValueContainer.setBackground(Background.fill(Paint.valueOf(&quot;lightblue&quot;)));</span>
        } else {
<span class="fc" id="L230">            final String[] senderName = {&quot;&quot;};</span>
<span class="fc" id="L231">            usersService.getUser(message.sender()).map(</span>
                    user -&gt; {
<span class="fc" id="L233">                        senderName[0] = user.name();</span>
<span class="fc" id="L234">                        return user;</span>
                    }
<span class="fc" id="L236">            ).subscribe().dispose();</span>

<span class="fc" id="L238">            authorAndTime.setText(senderName[0] +</span>
                    &quot; &quot; +
<span class="fc" id="L240">                    formatTimeString(message.createdAt()) +</span>
                    &quot; &quot;);
        }

<span class="pc bpc" id="L244" title="1 of 2 branches missed.">        edited.setVisible(!Objects.equals(message.updatedAt(), message.createdAt()));</span>

<span class="fc" id="L246">        newMessageInfoArea.getChildren().add(authorAndTime);</span>
<span class="fc" id="L247">        newMessageInfoArea.getChildren().add(edited);</span>

<span class="fc" id="L249">        Button editButton = new Button(&quot;\u270F&quot;);</span>
<span class="fc" id="L250">        editButton.setOnAction(event -&gt; {</span>
<span class="nc" id="L251">            TextInputDialog dialog = new TextInputDialog(&quot;&quot;);</span>
<span class="nc" id="L252">            dialog.setTitle(&quot;Edit message&quot;);</span>
<span class="nc" id="L253">            dialog.setHeaderText(null);</span>
<span class="nc" id="L254">            dialog.setContentText(&quot;Message:&quot;);</span>

<span class="nc" id="L256">            TextArea messageArea = new TextArea();</span>
<span class="nc" id="L257">            messageArea.setText(message.body());</span>
<span class="nc" id="L258">            messageArea.setPrefRowCount(4);</span>

<span class="nc" id="L260">            dialog.getDialogPane().setContent(messageArea);</span>
<span class="nc" id="L261">            Button ok = (Button) dialog.getDialogPane().lookupButton(ButtonType.OK);</span>
<span class="nc" id="L262">            ok.setOnAction(event1 -&gt; disposables.add(messageService.updateMessage(chatID, message._id(), messageArea.getText(), MESSAGE_NAMESPACE_GROUPS)</span>
<span class="nc" id="L263">                    .observeOn(FX_SCHEDULER).subscribe()));</span>
<span class="nc" id="L264">            dialog.showAndWait();</span>
<span class="nc" id="L265">        });</span>

<span class="fc" id="L267">        Button deleteButton = new Button(&quot;\uD83D\uDDD1&quot;);</span>
<span class="fc" id="L268">        deleteButton.setOnAction(event -&gt; {</span>
<span class="nc" id="L269">            Alert deleteAlert = new Alert(Alert.AlertType.CONFIRMATION);</span>
<span class="nc" id="L270">            deleteAlert.setTitle(&quot;Confirm delete&quot;);</span>
<span class="nc" id="L271">            deleteAlert.setHeaderText(null);</span>
<span class="nc" id="L272">            deleteAlert.setContentText(&quot;Do you really want to delete this message?&quot;);</span>

<span class="nc" id="L274">            deleteAlert.showAndWait().ifPresent(response -&gt; {</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                if (response == ButtonType.OK) {</span>
<span class="nc" id="L276">                    disposables.add(messageService.deleteMessage(message._id(), chatID, Constants.MESSAGE_NAMESPACE_GROUPS)</span>
<span class="nc" id="L277">                            .observeOn(FX_SCHEDULER).subscribe());</span>
                }
<span class="nc" id="L279">                deleteAlert.close();</span>
<span class="nc" id="L280">            });</span>
<span class="nc" id="L281">        });</span>
<span class="fc" id="L282">        newMessageInfoArea.getChildren().addAll(editButton, deleteButton);</span>

<span class="fc" id="L284">        newMessageInfoArea.setFillHeight(true);</span>
<span class="fc" id="L285">        HBox.setMargin(editButton, new Insets(0, 0, 0, 5));</span>
<span class="fc" id="L286">        HBox.setMargin(deleteButton, new Insets(0, 0, 0, 5));</span>
<span class="fc" id="L287">        editButton.setVisible(false);</span>
<span class="fc" id="L288">        deleteButton.setVisible(false);</span>

<span class="fc" id="L290">        newMessageNode.getChildren().add(newMessageValueArea);</span>
<span class="fc" id="L291">        newMessageNode.getChildren().add(newMessageInfoArea);</span>

<span class="fc" id="L293">        newMessageNode.hoverProperty().addListener((observable, oldValue, newValue) -&gt; {</span>
<span class="fc" id="L294">            editButton.setVisible(newValue);</span>
<span class="fc" id="L295">            deleteButton.setVisible(newValue);</span>
<span class="fc" id="L296">        });</span>

<span class="fc" id="L298">        return newMessageNode;</span>
    }

    private String formatTimeString(String dateTime) {
<span class="fc" id="L302">        LocalDateTime localDateTime = LocalDateTime.ofInstant(Instant.parse(dateTime), ZoneId.of(&quot;Europe/Berlin&quot;));</span>

<span class="fc" id="L304">        DateTimeFormatter outputFormatter = DateTimeFormatter.ofPattern(&quot;HH:mm, dd.MM.yy&quot;);</span>
<span class="fc" id="L305">        return localDateTime.format(outputFormatter);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>